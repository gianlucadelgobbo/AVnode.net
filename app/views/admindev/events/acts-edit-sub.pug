// Availability
- var count = 0;
- console.log("Availability")
- var subscriptionsIndex = call.subscriptions.map(item => {return item.subscriber_id._id.toString()})
input(type='hidden', name="program", value=call._id.toString())
- for (var b=0;b<call.performance.users.length;b++)
  - if (call.performance.users[b].members && call.performance.users[b].members.length)
    - for (var c=0;c<call.performance.users[b].members.length;c++)
      - var index = subscriptionsIndex.indexOf(call.performance.users[b].members[c]._id.toString())
      - var user = call.performance.users[b].members[c]
        include acts-edit-sub-row
        //.row.mb-3
          .col-1
            .text-center
              input.switch(disabled=call.subscriptions[index] && call.subscriptions[index].freezed ? "disabled" : undefined, id="subscription"+b+"_"+c, name=!call.subscriptions[index] || !call.subscriptions[index].freezed ? "subscriptions[" + count + "][subscriber_id]" : undefined, value=call.performance.users[b].members[c]._id, onchange="$(this).parent().parent().parent().find('.subscription').slideToggle('slide');var stagename = this.checked ? '"+call.performance.users[b].members[c].stagename+"' : '';$(this).parent().find('.stagename').val(stagename);",type="checkbox",autocomplete="off", checked=(call.subscriptions && call.subscriptions[index] && call.subscriptions[index].subscriber_id ? "checked" : undefined))
              input.stagename(name="subscriptions[" + count + "][stagename]", type="hidden", value=call.performance.users[b].members[c].stagename)
              if (call.subscriptions[index] && call.subscriptions[index].freezed)
                input(name="subscriptions[" + count + "][freezed]", type="hidden", value='true')
                input(name="subscriptions[" + count + "][subscriber_id]", type="hidden", value=call.performance.users[b].members[c]._id)
          .col-11
            label(for="subscription"+b+"_"+c)
              h3(class=call.subscriptions[index] && call.subscriptions[index].freezed ? "mb-0" : undefined)
                !=call.performance.users[b].members[c].stagename
            if (call.subscriptions[index] && call.subscriptions[index].freezed)
              p!=global.__("This person is already in with another act and can not be edited")
            else
              .subscription(style=!call.subscriptions || !call.subscriptions[index] || !call.subscriptions[index].subscriber_id ? "display: none" : undefined)
                - var dates = call.subscriptions && call.subscriptions[index] &&  call.subscriptions[index].days ? call.subscriptions[index].days : []
                - var days = [];
                - for (var d=0;d<call.event.schedule.length;d++)
                  - if (days.indexOf(call.event.schedule[d].date_formatted) == -1)
                    - days.push(call.event.schedule[d].date_formatted)
                    - var stringdate = new Date(call.event.schedule[d].date.getFullYear()+"-"+(("0" + (call.event.schedule[d].date.getMonth()+1)).slice(-2))+"-"+(("0" + (call.event.schedule[d].date.getDate())).slice(-2))+"T00:00:00.000Z")
                    - var datesindex = dates.findIndex(function(x) { 
                    -  return x.valueOf() === stringdate.valueOf(); 
                    - });
                    .form-check
                      input.form-check-input(disabled=call.subscriptions[index] && call.subscriptions[index].freezed ? "disabled" : undefined, id="subscription"+b+"_"+c+"_"+d, name=!call.subscriptions[index] || !call.subscriptions[index].freezed ? "subscriptions[" + count + "][days][" + d + "]" : undefined, value=call.event.schedule[d].date,    type="checkbox", checked=datesindex!=-1 ? "checked" : undefined)
                      label.form-check-label(for="subscription"+b+"_"+c+"_"+d)
                        !=" "+call.event.schedule[d].date_formatted
                      if (call.subscriptions[index] && call.subscriptions[index].freezed)
                        input(name="subscriptions[" + count + "][days][" + d + "]", value=call.event.schedule[d].date, type="hidden")
      - count++
  - else
    - var index = subscriptionsIndex.indexOf(call.performance.users[b]._id.toString())
    - var user = call.performance.users[b]
      include acts-edit-sub-row
    - count++
.mb-3
  b="REFERENCE"
  select.form-control(name="reference")
    option="NO REFERENCE"
    each user in call.performance.users
      if user.members && user.members.length
        each member in user.members
          option(value=member._id, selected=member._id.toString()==call.reference._id.toString() ? "selected" : undefined)=member.stagename
      else
        option(value=user._id, selected=user._id.toString()==call.reference._id.toString() ? "selected" : undefined)=user.stagename
